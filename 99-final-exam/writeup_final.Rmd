---
title: "Final Exam"
output: html_document
---

# Instructions

The final exam will be a 30 minute one-on-one oral exam with the instructor recorded in Zoom. Please prepare solutions to the following is a set of questions. During the oral exam, the instructor will ask a series of questions covering topics from the course and the questions. For example, the instructor may ask:

1. Please explain how you solved a particular question.
1. Please solve a new question (perhaps closely related to a question below).
1. Please explain course topic X.

You will be graded on both the accuracy of your responses and the clarity with which you explain course concepts and solutions to questions.

The final exam should represent your own work.  Do not consult with or collaborate in any way with anyone other than the instructor.

Prior to meeting with the instructor, you should:

   + Create a folder in your Probability and Inference Portfolio; call it `99-final-exam`.
   + Compile, save, and push your solutions to your GitHub repository

# 1. Simulation

The Monte Hall problem is a classic game show.  Contestants on the show where shown three doors.  Behind one randomly selected door was a sportscar; behind the other doors were goats.

At the start of the game, contestants would select a door, say door A.  Then, the host would open either door B or C to reveal a goat.  At that point in the game, the host would ask the contestant if she would like to change her door selection.  Once a contestant decided to stay or change, the host would open the choosen door to reveal the game prize, either a goat or a car.

In this problem, consider a **modified** version of the Monte Hall problem in which the number of doors is **variable**.  Rather than 3 doors, consider a game with 4 or 5 or 50 doors.  In the modified version of the game, a contestant would select an initial door, say door A.  Then, the host would open **one** of the remaining doors to reveal a goat.  At that point in the game, the host would ask the contestant if she would like to change her door selection.  Once a contestant decided to stay or change, the host would open the choosen door to reveal the game prize, either a goat or a car.

Consider two strategies:
  
  1. Always stay with the first door selected.
  2. Always switch to the unopened door.

**C.** The function `game` below plays a single game of Monte Hall.  The function returns a vector of length two, the first element is the prize under strategy 1 and the second element is the prize under strategy 2.  The function has a single input parameter, N, which is the number of doors in the game.

Use the `game` function to estimate the probability that both strategies result in a goat. Let **N=4**.

```{r}
require(magrittr)
require(dplyr)
library(tidyverse)

game <- function(N){
  if(N<3) stop("Must have at least 3 doors")
  prize <- sample(c(rep("goat",N-1),"car"), N)
  guess <- sample(1:N,1)
  game <- data.frame(door = 1:N, prize = prize, stringsAsFactors = FALSE) %>% 
    mutate(first_guess = case_when(
      door == guess ~ 1
      , TRUE ~ 0
    )) %>% 
    mutate(potential_reveal = case_when(
        first_guess == 1 ~ 0
      , prize == "car" ~ 0
      , TRUE ~ 1
    )) %>% 
    mutate(reveal = 1*(rank(potential_reveal, ties.method = "random") == 3)) %>% 
    mutate(potential_switch = case_when(
      first_guess == 1 ~ 0
      , reveal == 1 ~ 0
      , TRUE ~ 1
    )) %>% 
    mutate(switch = 1*(rank(potential_switch, ties.method = "random") == 3))
  c(game$prize[game$first_guess == 1], game$prize[game$switch == 1])
}
```

```{r}
set.seed(1)
R <- 1000
result <- NA
out <- rep(NA, R)
for(i in 1:R){
  result <- game(4)
  if(result[[1]] == "goat" & result[[2]] == "goat" ){
    out[i] <- 1
  }else{
    out[i] <- 0
  }
}
mean(out)
```

The probability that both strategies result in a goat is 0.387

**B**. Continuing from part **C**, what is the probability that at least one of the strategies results in winning a car?

```{r}
set.seed(1)
R <- 1000
result <- NA
out <- rep(NA, R)
for(i in 1:R){
  result <- game(4)
  if(result[[1]] == "car" | result[[2]] == "car" ){
    out[i] <- 1
  }else{
    out[i] <- 0
  }
}
mean(out)
```

The probability that at least one of the strategies results in winning a car is 0.613

**A**. Communicate the precision of your simulated probability in part **B** by calculating a **99\%** confidence interval.

```{r}
sum(out)
```

```{r}
prop.test(sum(out), R, conf.level = 0.99)
```

The probability that at least one of the strategies results in winning a car has a CI between 0.5721994 and 0.6522923

# 2. Probability

Consider a test for a rare genetic condition.  Let T+ denote a test result that indicates the condition is present, while T- denotes absence.  Let D+ and D- denote the true status of the disease.

**C**.  Fill-in the probability table using the following information:

+ P(T+|D+) = .85,  and 
+ P(T-|D-) = .95,  and 
+ P(D+) = 0.001

|    |    D+    |    D-    |         |
|:--:|:--------:|:--------:|:-------:|
| T+ | 0.00085  | 0.04995  |  0.0508 |
| T- | 0.00015  |  0.94905 |  0.9492 |
|    |   0.001  |  0.999   |    1    |

**B**. Calculate the **negative** predictive value of the test, P(D-|T-).

```{r}
0.94905/0.9492
```

P(D-|T-) is 0.999842.

**A** Create a plot that shows how the **positive** predictive value as a function of the prevalence of disease, P(D+).

```{r}
prevalence <- seq(0.001, 0.1, length = 50)
ppv <- (0.85*prevalence)/((0.85*prevalence)+(1-prevalence)*0.05)
plot(prevalence, ppv, xlab = "Prevalence", ylab = "PPV",main="positive predictive value as prevalence")
```

The figure is above

# 3. Discrete Distributions

Suppose the yearly hospital charges (in thousands of dollars) for a randomly selected Vanderbilt student is a mixture distribution.

For 50% of students, the hospital charges will be $0.  For the remaining 50% of students, the hospital charges are a random variable described by a gamma distribution with shape = 2 and scale = 2.  (Again, in thousands of dollars.)   

```{r}
hospital_charges <- function(N){
  group <- rbinom(N, 1, 0.5)
  charges <- 0*group + rgamma(N, shape = 2, scale = 2)*(1-group)
  charges
}
```

**C**.  What is the 90th percentile for yearly hospital charges for a randomly selected Vanderbilt student?

```{r}
set.seed(1)
R <- 500
result <- NA
out <- rep(NA, R)
for(i in 1:R){
  result <- hospital_charges(10000)
  out[i] <- quantile(result, 0.9)
}
mean(out)
```

The 90th percentile for yearly hospital charges for a randomly selected Vanderbilt student is 5.990074.

**B**.  Consider the **class** average yearly hospital charge for the students in a class of size 30.  Plot the density function or a simulated histogram of the class average yearly hospital charge.

```{r}
set.seed(1)
R <- 5000
result <- NA
out <- rep(NA, R)
for(i in 1:R){
  result <- hospital_charges(30)
  out[i] <- mean(result) #mean(result) quantile(result, 0.5)
}
hist(out, breaks = 100,main = "Histogram of the class average yearly hospital charge", xlab = "Thousands of dollars")
```

The figure is above.

**A**.  What is the probability that a randomly selected class of size 30 students will have less than 10 students with zero yearly hospital charges?

```{r}
# Probability of getting 9 or less (less than 10) students from 30 students class.
pbinom(9, 30, 0.5)
```

Probability of getting 9 or less (less than 10) students from 30 students class is 0.02138697.

# 4. Continuous Distributions

**C.** Suppose diastolic blood pressure (DBP) follows a normal distribution with mean 80 mmHg and SD 15 mmHg. What is the probability that a randomly sampled person鈥檚 DBP lies between 70 and 104 mmHg?

```{r}
pnorm(104,80,15) - pnorm(70,80,15)
```

The probability that a randomly sampled person DBP lies between 70 and 104 mmHg is 0.6927082.

**B.** Suppose a human femur was discovered that is 37 cm long.  Also suppose that using the NHANES data, researchers believe the distribution of femor bones, by sex, are distributed as follows:

+ Female adult femor $\sim N(36, 3.3)$
+ Male adult femor $\sim N(40, 3.4)$

```{r}
#![](leg-length-distributions.svg)
```


Under the assumption that male and females are equally likely, what is the probability that the discovered femor was from a male?

bayes rule: P(A|B) = P(B|A)P(A)/(P(B|A)P(A) + P(B|-A)P(-A))

```{r}
(dnorm(37,40,3.4)*0.5) /((dnorm(37,40,3.4)*0.5) + (dnorm(37,36,3.3)*0.5))
```

The probability that the discovered femor was from a male is 0.407765

**A.**  Continuing part **B**, generate a plot of P(femor from male | femor length = x).  Let femor length range from 25 to 50.

```{r}
femor_length <- 25:50
prob_male <- (dnorm(femor_length,40,3.4)*0.5) /((dnorm(femor_length,40,3.4)*0.5) + (dnorm(femor_length,36,3.3)*0.5))
plot.new()
plot.window(xlim = c(25,50), ylim = c(0,1))
lines(femor_length, prob_male)
axis(1)
axis(2)
box()
title(xlab = "Femor Length", ylab = "P( Male | femor length)")
```

The figure is above.

# 5. Expectation and Variance

Let us revisit the yearly hospital charges distribution from a previous section.

>**Recall:** The yearly hospital charges (in thousands of dollars) for a randomly selected Vanderbilt student is a mixture distribution. For 50% of students, the hospital charges will be $0.  For the remaining 50% of students, the hospital charges are a random variable described by a gamma distribution with shape = 2 and scale = 2.  (Again, in thousands of dollars.)   

```{r}
hospital_charges <- function(N){
  group <- rbinom(N, 1, 0.5)
  charges <- 0*group + rgamma(N, shape = 2, scale = 2)*(1-group)
  charges
}
```

**C.** What is E[yearly hospital charges]?

```{r}
set.seed(1)
mean(hospital_charges(5000))
```

E[yearly hospital charges] = 2.057602.

**B.** Suppose Vanderbilt implements a cap of \$10,000 on yearly student hospital charages.  What is the mean yearly hospital charge under the new policy?

```{r}
set.seed(1)
R <- 500
result <- NA
out <- rep(NA, R)
for(i in 1:R){
  result <- hospital_charges(5000)
  result[result > 10] = 10
  out[i] = mean(result)
}
mean(out)
```

The mean yearly hospital charge under the new policy is 1.951486.

**A.** What is the variance of yearly hospital charge under the new policy?

```{r}
set.seed(1)
R <- 500
result <- NA
out <- rep(NA, R)
for(i in 1:R){
  result <- hospital_charges(5000)
  result[result > 10] = 10
  out[i] = var(result)
}
mean(out)
```

The variance of yearly hospital charge under the new policy is 7.018316.

# 6. Transformations & Sampling Distributions

**C.** Consider the log normal distribution.  If X is a log normal random variable, then log(X) is a normal random variable.  One way to create pseudo-random draws from the log normal distribution is to generate draws from a normal distribution and then to transform the draws by expononentiating.  The parameters of the log normal distribution are the parameters of the underlying normal distribution, $\mu$ and $\sigma$ (or $\sigma^2$).  

Log normal data are prevalent is biological systems and econometrics.

Suppose a blood chemistry measure has a log normal distribution with $\mu$ = 0 and $\sigma$ = 1. Generate an histogram or density curve for the sampling distribution of the median when the sample size is 101.

```{r}
meds <- NA
R <- 5000
for (i in seq(1:R)){
  meds[i] <- rlnorm(101,meanlog = 0,sdlog = 1) %>% median()
}

#hist(meds, breaks = 50, main= "Histogram for the sampling distribution of the median")
plot(density(meds), col = "red", lwd = 3, main= "Density curve for the sampling distribution of the median")
```

The figure is above.

**B.** Below is the CDF function for the kth order statistic when the underlying distribution is log normal with $\mu$ = 0 and $\sigma$ = 1.  Create a plot of the ECDF of the simulated sampling distribution generated in **C** and overlay the CDF using the function below.

```{r}
Fk <- function(x,k,n){
  pbinom(k-1, n, plnorm(x), lower.tail = FALSE)
}
```

```{r}
plot(ecdf(meds), col = "red", lwd = 3, main= "ECDF and CDF of the simulated sampling distribution median")
curve(Fk(x, 51, 101), add =T, col = "blue", lwd = 3)
```

The figure is above.

**A.** Of the 25th, 50th, and 75th quantiles of the distribution from **B**, which will have the tighest 95% CI?  (Show the sampling distribution of each.)

```{r}
out_25 <- NA
out_50 <- NA
out_75 <- NA

for (i in 1:R){
  result <- rlnorm(101,meanlog = 0,sdlog = 1)
  out_25[i] <- quantile(result, 0.25)
  out_50[i] <- quantile(result, 0.5)
  out_75[i] <- quantile(result, 0.75)
}
```


```{r}
gap_25 <- quantile(out_25, c(0.05/2, 1-0.05/2))[2]-quantile(out_25, c(0.05/2, 1-0.05/2))[1]
gap_25
gap_50 <- quantile(out_50, c(0.05/2, 1-0.05/2))[2]-quantile(out_50, c(0.05/2, 1-0.05/2))[1]
gap_50
gap_75 <- quantile(out_75, c(0.05/2, 1-0.05/2))[2]-quantile(out_75, c(0.05/2, 1-0.05/2))[1]
gap_75
```

```{r}
plot(density(out_25), col = "red", xlim = c(0.3, 3.5), lwd = 3, main = "Distribution of 25th, 50th, 75th quantiles",xlab = "x")
lines(density(out_50), col = "green", lwd = 3)
lines(density(out_75), col = "blue", lwd = 3)
legend("topright", c("25th","50th", "75th"),lwd = 3,col = c("red","green", "blue"))
```

The figure is above. And the 25th quantiles of the distribution has the tighest 95% CI.

# 7. Estimation of CDF and PDF from data

The following code will load the NHANES data and select the first 500 rows.

```{r}
Hmisc::getHdata(nhgh)
d1 <- nhgh[1:500,]
```

**C.** Estimate the distribution of standing height for adult (age > 18) males using the MLE method with a normal distribution.  Create a plot of the estimated density function.

```{r}
male_adult_ht <-  d1 %>% filter(age > 18 , sex == "male") %>% select(ht)
male_adult_ht <- as.vector(male_adult_ht[['ht']])

mean_mle_male <- mean(male_adult_ht)
sd_mle_male <- sd(male_adult_ht) #we set (N-1)/N=N
hist(male_adult_ht, freq=F,breaks = 20,main = "Estimated male adult height by MLE", xlab = "male adult height")
curve(dnorm(x, mean(male_adult_ht), sd(male_adult_ht)),col="red",lwd=3,add=T)
```

The figure is above.

**B.** Estimate the distribution of BMI for adult (age > 18) females using using the method of moment method with the gamma distribution. Create a plot of the estimated density function.

```{r}
female_adult_bmi <-  d1 %>% filter(age > 18 , sex == "female") %>% select(bmi)
female_adult_bmi <- as.vector(female_adult_bmi[['bmi']])

mm_shape_gamma=mean(female_adult_bmi)^2/var(female_adult_bmi)
mm_scale_gamma=var(female_adult_bmi)/mean(female_adult_bmi)

hist(female_adult_bmi,breaks=50,freq = F,main = "Estimated female adult bmi by MM", xlab = "female adult bmi",xlim = c(0, 60))
curve(dgamma(x,shape=mm_shape_gamma,scale=mm_scale_gamma),col="red",lwd=3,add=T)
```

The figure is above.

**A.** Estimate the distribution of creatinine (SCr) for adults (age > 18) using the kernel density method with a gaussian kernel.  Create a plot of the estimated density function.

```{r}
adult_SCr <-  d1 %>% filter(age > 18 ) %>% select(SCr) %>% na.omit
adult_SCr <- as.vector(adult_SCr[['SCr']])

#Method 1
epdfstar <- function(t, data, smooth){
  outer(t, data, function(a,b){ dnorm(a, b, smooth)}) %>% rowMeans
}
hist(adult_SCr,freq = F,xlim = c(-4, 4), ylim = c(0, 1),main = "Estimated adult creatinine by kernel density method", xlab = "adult creatinine")
curve(epdfstar(x, adult_SCr, smooth = 1), add = TRUE, lwd = 3, col = "red")

```

Here is the first method. the hist is so wide and hard to simulate.

```{r,warning=F,message=F}
plot(density(
  adult_SCr,bw="nrd0",adjust=1,kernal= "gaussian"
))
```

Here is the second method.

# 8. Sample from an estimated distribution

The following code will load the low birth weight data from the MASS package.  The description of the variables in the dataset can be found in the birthwt documentation with the command `?MASS::birthwt`.

```{r}
bwt <- MASS::birthwt
```

**C.** Generate a 95% confidence interval for the mean birthweight of infants whose mothers **did** smoke during pregnancy using the bootstrap.

```{r}
bwt_smoke <-  bwt %>% filter(smoke == 1) %>% select(bwt) 
bwt_smoke <- as.vector(bwt_smoke[['bwt']])

out <- rep(NA, R)
for (i in 1:R){
  out[i] <- sample(bwt_smoke, length(bwt_smoke), replace = T) %>% mean()
}

quantile(out, c(0.05/2, 1-0.05/2))
```

95% confidence interval for the mean birthweight of infants whose mothers did smoke during pregnancy using the bootstrap is between ```r quantile(out, c(0.05/2, 1-0.05/2))[1]``` and 
```r quantile(out, c(0.05/2, 1-0.05/2))[2]```

**B.** Generate a 95% confidence interval for the mean birthweight of infants whose mothers **did** smoke during pregnancy using the Central Limit Theorem shortcut.

```{r}
#By hand 
R <- 2000
means <- rep(NA, R)
mean_mle <- mean(bwt_smoke, na.rm = TRUE)
sd_mle <- sd(bwt_smoke, na.rm = TRUE)
for(i in 1:R){
  s <- rnorm(length(bwt_smoke), mean = mean_mle, sd = sd_mle)
  means[i] <- mean(s)
}
alpha <- 0.05
quantile(means, c(alpha/2, 1-alpha/2))
```


```{r}
R <- 5000
N <- length(bwt_smoke) 
pop_mean <- mean(bwt_smoke) 
pop_sd <- sd(bwt_smoke)
sim_norm <- rnorm(R)
sample_dist_clt <- sim_norm*(pop_sd/sqrt(N))+pop_mean
pop_mean
quantile(sample_dist_clt,c(0.025,0.975))
```


```{r}
#By R
t.test(bwt_smoke)
```

95% confidence interval for the mean birthweight of infants whose mothers did smoke during pregnancy by CLT is between 2619.094 and 2924.744.

**A.** Let $\mu_s$ be the mean birthweight of infants whose mothers smoked during pregnancy.  Let $\mu_{ns}$ be the mean for the non-smoking group.  Use simulation to calculate the 95% confidence interval for $\mu_s/\mu_{ns}$.

```{r}
set.seed(1)
bwt_nosmoke <-  bwt %>% filter(smoke == 0) %>% select(bwt) 
bwt_nosmoke <- as.vector(bwt_nosmoke[['bwt']])

out <- rep(NA, R)
out_smoke <- NA
out_nosmoke <- NA
for (i in 1:R){
  out_smoke[i] <- sample(bwt_smoke, length(bwt_smoke), replace = T) %>% mean()
  out_nosmoke[i] <- sample(bwt_nosmoke, length(bwt_nosmoke), replace = T) %>% mean()
  out[i] <- out_smoke[i]/out_nosmoke[i]
}

quantile(out, c(0.05/2, 1-0.05/2))
```

The 95% confidence interval for $\mu_s/\mu_{ns}$ is 0.8437555 and 0.9703722.

# 9.  Inference

**C.** Suppose two studies were performed looking at the risk of mild complication after hernia repair using open and laparoscopic surgical approaches.  The study results are below.  Using the data from each study individually, perform the hypothesis test that the risk of complication between open and laparoscopic repairs are the same under the usual point null. What is the p-value from each study?  What do you conclude from each study?


| Study 1 | Comp | No comp |
|:---|:---|:---|
| Open | 30 | 70 |
| Lap  | 35 | 65 |

| Study 2 | Comp | No comp |
|:---|:---|:---|
| Open | 600 |     1400 |
| Lap  | 619 |     1381 |

```{r}
prop.test(c(30, 35), c(100,100))
```

```{r}
prop.test(c(600, 619), c(2000, 2000))
```

p = 0.5459 in the first study and  p = 0.5364 in the second one. We can find that in both study, 0 is included in the 95% CI. 

We can conclude that in both study, we cannot reject the null assumption because p > 0.05 in both studies. Also, 0 is in both 95% CI, it's kind of a double check that we fail to reject H0. So, the risk of complication between open and laparoscopic repairs are the same.

**B.** Suppose that prior to the studies, the researchers established an equivalence threshold of 6 percentage points.  Using the confidence intervals, which studies (if any) showed a conclusive similarity between surgical approaches for the complication rate.  Explain why.

The second study showed a conclusive similarity between surgical approaches for the complication rate. Because the second's CI is from -0.03852774 to  0.01952774, which is in -0.06 to 0.06. We can get a conclusive similarity. But the first one is from -0.18963943 to 0.08963943, so we cannot get the conclusion.

**A.** If the data from the studies were combined, what is the smallest equivalence threshold that would identify a conclusive similarity between the surgical approaches?

```{r}
prop.test(c(630, 654), c(630+1470, 654+1446))
```

The 95% CI is from -0.03976899 to  0.01691185, so we can get an equivalence threshold of 4 percentage points, which is from -0.04 to 0.04.

# 10.  Joint Distributions

**C.** Fill in the blank.  The sample correlation is a measure of _________linear_______ association.

**B.** Explain why predictions from a conditional distribution generally have smaller prediction error than predictions from the marginal distribution.

We can think of the joint distribution as an ellipse. The conditional distribution would has a smaller variance than the marginal distribution. When making predictions, smaller variances have smaller errors. Of course, these are for correlated distribution. If not correlated, they should be same. Also, we can use MSE.If they both have 0 bias, then the MSE would be the variance. The conditional distribution has an equal or smaller variance than the marginal distribution, so the MSE of conditional distribution is equal or small to marginal distribution.

**A.** Use the CLT shortcut to calculate the 95% confidence interval for the correlation of arm circumferance and arm length using the NHANES dataset.  Is the sample correlation a reasonable measure of association for this data?

```{r}
cor.test(nhgh$armc, nhgh$arml)
```

The sample correlation is a reasonable measure of association for this data. From  the chart, the p value is less than 0.05 and 95% CI does not include 0. So  we reject null hypothesis, which is they are not correlated. So they are correlated and the sample correlation is a reasonable measure of association for this data.


